<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Pong Ultra</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;background:#05070d;color:white;font-family:system-ui}
canvas{display:block}
.menu{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px}
button,input{padding:14px 20px;border-radius:12px;border:none;font-size:18px}
</style>
</head>
<body>

<div id="menu" class="menu">
  <h1>PONG ULTRA</h1>
  <button onclick="local()">Local</button>
  <button onclick="host()">Host Online</button>
  <input id="code" placeholder="Room Code">
  <button onclick="join()">Join</button>
</div>

<canvas id="c"></canvas>

<script>
const WS_URL = "free-moth-78.noaheburne-ux.deno.net";
const c = document.getElementById("c");
const x = c.getContext("2d");
resize(); onresize = resize;

function resize(){c.width=innerWidth;c.height=innerHeight}

let socket, room, role;
let state = {
  paddles:[{y:200},{y:200}],
  ball:{x:300,y:200,vx:400,vy:300}
};

function local(){
  role="host"; room="local";
  start();
}

function host(){
  socket=new WebSocket(WS_URL);
  socket.onopen=()=>socket.send(JSON.stringify({type:"host"}));
  socket.onmessage=e=>{
    const m=JSON.parse(e.data);
    if(m.type==="room"){room=m.room;alert("Room: "+room)}
    if(m.type==="start"){role="host";start()}
  };
}

function join(){
  socket=new WebSocket(WS_URL);
  socket.onopen=()=>socket.send(JSON.stringify({type:"join",room:code.value.toUpperCase()}));
  socket.onmessage=e=>{
    const m=JSON.parse(e.data);
    if(m.type==="start"){role="client";start()}
    if(m.type==="state")state=m.state;
  };
}

let input={up:false,down:false};
onkeydown=e=>{if(e.key=="ArrowUp")input.up=true;if(e.key=="ArrowDown")input.down=true};
onkeyup=e=>{if(e.key=="ArrowUp")input.up=false;if(e.key=="ArrowDown")input.down=false};

function start(){
  menu.style.display="none";
  requestAnimationFrame(loop);
}

let last=performance.now();
function loop(t){
  const dt=(t-last)/1000; last=t;

  if(role==="host"){
    if(input.up)state.paddles[0].y-=500*dt;
    if(input.down)state.paddles[0].y+=500*dt;

    state.ball.x+=state.ball.vx*dt;
    state.ball.y+=state.ball.vy*dt;

    if(state.ball.y<0||state.ball.y>c.height)state.ball.vy*=-1;

    socket?.send(JSON.stringify({type:"state",room,state}));
  } else {
    socket?.send(JSON.stringify({type:"input",room,input}));
  }

  render();
  requestAnimationFrame(loop);
}

function render(){
  x.clearRect(0,0,c.width,c.height);
  x.fillStyle="#7cf";
  x.fillRect(40,state.paddles[0].y-60,12,120);
  x.fillRect(c.width-52,state.paddles[1].y-60,12,120);
  x.beginPath();
  x.arc(state.ball.x,state.ball.y,8,0,Math.PI*2);
  x.fillStyle="#fff"; x.fill();
}
</script>
</body>
</html>
